services:
  # Backend API service
  - type: web
    name: finpath-insight-api
    env: python
    region: singapore  # Choose a region close to your users
    plan: starter  # Adjust based on your needs
    buildCommand: |
      cd fastapi-backend
      pip install --upgrade pip
      pip install -r requirements.txt
      # Run database setup script during build
      python -m app.scripts.update_database
    startCommand: |
      cd fastapi-backend
      uvicorn app.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/health/live
    autoDeploy: true
    # Set reasonable timeouts for long-running operations
    httpTimeout: 60
    # Increase memory limit for better performance
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 80
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8000
      - key: LOG_LEVEL
        value: INFO
      - key: REQUEST_TIMEOUT
        value: 60
      - key: MAX_RETRIES
        value: 3
      - key: RATE_LIMIT_WINDOW
        value: 60
      - key: RATE_LIMIT_MAX_REQUESTS
        value: 5
      - key: YAHOO_BATCH_SIZE
        value: 2
      - key: YAHOO_RATE_LIMIT_WINDOW
        value: 60
      - key: YAHOO_MAX_REQUESTS
        value: 5
      - key: SUPABASE_TTL_CACHE
        value: 3600
      # Secrets that should be set in the Render dashboard
      - key: GEMINI_API_KEY
        sync: false
      - key: PINECONE_API_KEY
        sync: false
      - key: PINECONE_INDEX_NAME
        sync: false
      - key: ALPHA_VANTAGE_API_KEY
        sync: false
      - key: NEWS_API_KEY
        sync: false
      - key: FMP_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false

  # Frontend static site
  - type: web
    name: finpath-insight-frontend
    env: static
    buildCommand: |
      cd src
      npm install
      npm run build
    staticPublishPath: ./src/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    headers:
      - path: /*
        name: Cache-Control
        value: no-cache
    envVars:
      - key: VITE_API_URL
        value: https://finpath-insight-api.onrender.com
      - key: NODE_ENV
        value: production

# Database service (if you're not using Supabase)
# - type: pserv
#   name: finpath-insight-db
#   env: docker
#   dockerfilePath: ./db/Dockerfile
#   disk:
#     name: data
#     mountPath: /var/lib/postgresql/data
#     sizeGB: 10

# Scheduled jobs for data updates
- type: cron
  name: finpath-insight-data-update
  env: python
  schedule: "0 */6 * * *"  # Run every 6 hours
  buildCommand: |
    cd fastapi-backend
    pip install --upgrade pip
    pip install -r requirements.txt
  startCommand: |
    cd fastapi-backend
    # Update database and refresh market data
    python -m app.scripts.update_database
    python -m app.scripts.update_market_data
  envVars:
    - key: NODE_ENV
      value: production
    # Include the same environment variables as the API service
    - key: SUPABASE_URL
      sync: false
    - key: SUPABASE_ANON_KEY
      sync: false
    - key: FMP_API_KEY
      sync: false
    - key: ALPHA_VANTAGE_API_KEY
      sync: false
    - key: NEWS_API_KEY
      sync: false
